<!DOCTYPE html>
<!-- Created by Ruben Ceuppens with passion for media -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A/B Test — Minimum Detectable Effect</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap');
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #f3f6f8;
    color: #1a1a1a;
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .card {
    background: #fff;
    border: 1px solid #dce6f0;
    border-radius: 8px;
    padding: 2.5rem 2.5rem 2rem;
    max-width: 860px;
    width: 100%;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    background: linear-gradient(90deg, #0a66c2, #00a0dc);
  }

  .header { margin-bottom: 1.5rem; }

  .label {
    font-size: 0.65rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: #0a66c2;
    margin-bottom: 0.4rem;
  }

  h1 { font-size: 1.6rem; font-weight: 700; color: #1a1a1a; line-height: 1.2; margin-bottom: 0.4rem; }
  .subtitle { font-size: 0.8rem; color: #666; }

  .inputs-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 560px) { .inputs-row { grid-template-columns: 1fr; } }

  .input-panel {
    background: #f3f6f8;
    border: 1px solid #dce6f0;
    border-radius: 8px;
    padding: 1.1rem 1.25rem 0.9rem;
  }

  .input-panel-title {
    font-size: 0.62rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: #0a66c2;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .pip { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }

  .input-row { display: flex; align-items: flex-start; gap: 0.75rem; }

  .input-group { display: flex; flex-direction: column; gap: 0.3rem; flex: 1; }

  .input-group label {
    font-size: 0.62rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #888;
  }

  .input-group input {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.92rem;
    color: #1a1a1a;
    background: #fff;
    border: 1.5px solid #c5d8ed;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    outline: none;
    transition: border-color 0.15s;
    width: 100%;
  }

  .input-group input:focus { border-color: #0a66c2; }
  .input-group input.error { border-color: #e05252; }

  .error-msg { font-size: 0.65rem; color: #e05252; min-height: 0.9rem; }

  .result-badge {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.15rem;
    min-width: 80px;
    padding-top: 1.4rem;
  }

  .badge-val { font-size: 1.3rem; font-weight: 700; line-height: 1; }
  .badge-detail { font-size: 0.62rem; color: #888; text-align: right; }

  .verdict {
    border-radius: 8px;
    padding: 0.85rem 1.25rem;
    margin-bottom: 1.5rem;
    font-size: 0.82rem;
    display: none;
    align-items: center;
    gap: 0.75rem;
  }

  .verdict.show { display: flex; }
  .verdict.detectable { background: #eaf4ee; border: 1px solid #7bc99a; color: #2d7a4f; }
  .verdict.not-detectable { background: #fdf0ee; border: 1px solid #f0a090; color: #b94040; }
  .verdict.partial { background: #fdf8ee; border: 1px solid #e8c96a; color: #7a5c10; }

  .verdict-icon { font-size: 1.1rem; flex-shrink: 0; }
  .verdict-text { line-height: 1.4; }
  .verdict-text strong { font-weight: 700; }

  .chart-wrap { position: relative; height: 360px; }

  .legend { display: flex; gap: 1.25rem; margin-top: 1rem; align-items: center; flex-wrap: wrap; }

  .legend-item { display: flex; align-items: center; gap: 0.45rem; font-size: 0.7rem; color: #666; }

  .legend-line { width: 22px; height: 3px; border-radius: 2px; }
  .legend-line.dashed {
    background: repeating-linear-gradient(90deg, #00a0dc 0, #00a0dc 5px, transparent 5px, transparent 9px);
    height: 2px;
  }
  .legend-line.imp-marker {
    background: repeating-linear-gradient(90deg, #ff6b35 0, #ff6b35 4px, transparent 4px, transparent 7px);
    height: 2px;
  }
  .legend-line.ctr-marker {
    background: repeating-linear-gradient(90deg, #9b59b6 0, #9b59b6 4px, transparent 4px, transparent 7px);
    height: 2px;
  }

  .params { display: flex; gap: 2rem; margin-top: 1.5rem; padding-top: 1.25rem; border-top: 1px solid #dce6f0; flex-wrap: wrap; }
  .param { display: flex; flex-direction: column; gap: 0.2rem; }
  .param-label { font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: #aaa; }
  .param-value { font-size: 0.82rem; color: #0a66c2; }
</style>
</head>
<body>
<div class="card">
  <div class="header">
    <div class="label">A/B Test Sensitivity</div>
    <h1>Minimum Detectable Effect</h1>
    <div class="subtitle">Enter your impressions and/or observed CTR difference to visualise test sensitivity.</div>
  </div>

  <div class="inputs-row">
    <div class="input-panel">
      <div class="input-panel-title">
        <span class="pip" style="background:#ff6b35;"></span>
        Impressions per variant
      </div>
      <div class="input-row">
        <div class="input-group">
          <label for="imp-input">Number of impressions</label>
          <input type="number" id="imp-input" placeholder="e.g. 25000" min="100" max="10000000" />
          <div class="error-msg" id="imp-error"></div>
        </div>
        <div class="result-badge">
          <span class="badge-val" id="imp-mde-val" style="color:#ff6b35;">—</span>
          <span class="badge-detail" id="imp-mde-detail">MDE (α 0.05)</span>
        </div>
      </div>
    </div>

    <div class="input-panel">
      <div class="input-panel-title">
        <span class="pip" style="background:#9b59b6;"></span>
        Observed CTR / ER difference
      </div>
      <div class="input-row">
        <div class="input-group">
          <label for="ctr-input">Difference in % points</label>
          <input type="number" id="ctr-input" placeholder="e.g. 0.3" min="0.001" max="5" step="0.01" />
          <div class="error-msg" id="ctr-error"></div>
        </div>
        <div class="result-badge">
          <span class="badge-val" id="ctr-imp-val" style="color:#9b59b6;">—</span>
          <span class="badge-detail" id="ctr-imp-detail">impressions needed</span>
        </div>
      </div>
    </div>
  </div>

  <div class="verdict" id="verdict">
    <span class="verdict-icon" id="verdict-icon"></span>
    <span class="verdict-text" id="verdict-text"></span>
  </div>

  <div class="chart-wrap">
    <canvas id="chart"></canvas>
  </div>

  <div class="legend">
    <div class="legend-item">
      <div class="legend-line" style="background:#0a66c2;"></div>
      α = 0.05
    </div>
    <div class="legend-item">
      <div class="legend-line dashed"></div>
      α = 0.10
    </div>
    <div class="legend-item">
      <div class="legend-line imp-marker"></div>
      Your impressions
    </div>
    <div class="legend-item">
      <div class="legend-line ctr-marker"></div>
      Your CTR difference
    </div>
  </div>

  <div class="params">
    <div class="param">
      <span class="param-label">Baseline CTR</span>
      <span class="param-value">1.0%</span>
    </div>
    <div class="param">
      <span class="param-label">Power</span>
      <span class="param-value">80%</span>
    </div>
    <div class="param">
      <span class="param-label">Test type</span>
      <span class="param-value">Two-tailed z-test</span>
    </div>
    <div class="param">
      <span class="param-label">Impressions</span>
      <span class="param-value">Per variant</span>
    </div>
  </div>
</div>

<script>
const P0 = 0.01; // baseline CTR

// ── Core formulas ─────────────────────────────────────────────────────────────
// Two-proportion z-test, baseline p0=1%, 80% power
// z_alpha: 1.96 (α=0.05) or 1.645 (α=0.10)
// z_beta:  0.842 (80% power)
// MDE = (z_alpha + z_beta) * sqrt(2 * p0 * (1-p0) / n)

function calcMDE(n, alpha) {
  var z_alpha = alpha === 0.05 ? 1.96 : 1.645;
  var z_beta  = 0.842;
  return ((z_alpha + z_beta) * Math.sqrt(2 * P0 * (1 - P0) / n)) * 100;
}

function calcN(d, alpha) {
  var z_alpha = alpha === 0.05 ? 1.96 : 1.645;
  var z_beta  = 0.842;
  var dFrac = d / 100;
  return Math.ceil(2 * P0 * (1 - P0) * Math.pow((z_alpha + z_beta) / dFrac, 2));
}

function buildCurve(alpha) {
  var pts = [];
  for (var i = 0; i <= 150; i++) {
    var n = Math.round(Math.pow(10, 2.7 + i * (6 - 2.7) / 150));
    pts.push({ x: n, y: parseFloat(calcMDE(n, alpha).toFixed(4)) });
  }
  return pts;
}

// ── Chart ─────────────────────────────────────────────────────────────────────
var ctx = document.getElementById('chart').getContext('2d');

var chart = new Chart(ctx, {
  type: 'line',
  data: {
    datasets: [
      {
        label: 'α = 0.05',
        data: buildCurve(0.05),
        borderColor: '#0a66c2',
        backgroundColor: 'rgba(34,139,70,0.13)',
        borderWidth: 2.5,
        pointRadius: 0,
        fill: { value: 2.0 },
        tension: 0.1,
        order: 4,
      },
      {
        label: 'α = 0.10',
        data: buildCurve(0.10),
        borderColor: '#00a0dc',
        backgroundColor: 'transparent',
        borderWidth: 2.5,
        borderDash: [6, 4],
        pointRadius: 0,
        fill: false,
        tension: 0.1,
        order: 3,
      },
      {
        label: 'Impressions marker',
        data: [],
        borderColor: '#ff6b35',
        borderWidth: 2,
        borderDash: [4, 3],
        pointRadius: 5,
        pointBackgroundColor: '#ff6b35',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        fill: false,
        tension: 0,
        order: 1,
      },
      {
        label: 'CTR diff marker',
        data: [],
        borderColor: '#9b59b6',
        borderWidth: 2,
        borderDash: [4, 3],
        pointRadius: 5,
        pointBackgroundColor: '#9b59b6',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        fill: false,
        tension: 0,
        order: 2,
      },
      {
        label: 'Intersection',
        data: [],
        borderColor: 'transparent',
        pointRadius: 9,
        pointBackgroundColor: '#1a1a1a',
        pointBorderColor: '#fff',
        pointBorderWidth: 2.5,
        fill: false,
        order: 0,
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#fff',
        borderColor: '#dce6f0',
        borderWidth: 1,
        titleColor: '#666',
        bodyColor: '#1a1a1a',
        titleFont: { family: 'DM Sans', size: 11 },
        bodyFont: { family: 'DM Sans', size: 11 },
        padding: 12,
        filter: function(item) { return item.datasetIndex < 2; },
        callbacks: {
          title: function(items) { return 'Impressions: ' + fmtNum(Math.round(items[0].parsed.x)); },
          label: function(item) {
            var mde = item.parsed.y.toFixed(2);
            return ' ' + item.dataset.label + '  MDE: ' + mde + '%  (1.00% vs ' + (1 + parseFloat(mde)).toFixed(2) + '%)';
          }
        }
      }
    },
    scales: {
      x: {
        type: 'logarithmic',
        min: 500,
        max: 1000000,
        grid: { color: '#eef2f7' },
        ticks: {
          color: '#999',
          font: { family: 'DM Sans', size: 11 },
          callback: function(val) {
            var map = { 1000:'1K', 5000:'5K', 10000:'10K', 50000:'50K', 100000:'100K', 500000:'500K', 1000000:'1M' };
            return map[val] !== undefined ? map[val] : '';
          }
        },
        title: {
          display: true,
          text: 'Impressions per variant (log scale)',
          color: '#aaa',
          font: { family: 'DM Sans', size: 11 },
          padding: { top: 10 }
        }
      },
      y: {
        min: 0,
        max: 2.0,
        beginAtZero: true,
        grid: { color: '#eef2f7' },
        ticks: {
          color: '#999',
          font: { family: 'DM Sans', size: 11 },
          callback: function(v) { return v.toFixed(2) + '%'; }
        },
        title: {
          display: true,
          text: 'Min. detectable difference (% pts)',
          color: '#aaa',
          font: { family: 'DM Sans', size: 11 },
          padding: { bottom: 10 }
        }
      }
    }
  }
});

// ── State ─────────────────────────────────────────────────────────────────────
var currentN    = null;
var currentDiff = null;

// ── Helpers ───────────────────────────────────────────────────────────────────
function fmtNum(n) {
  if (n >= 1000000) return (n/1000000).toFixed(1).replace(/\.0$/,'') + 'M';
  if (n >= 1000)    return (n/1000).toFixed(1).replace(/\.0$/,'') + 'K';
  return n.toString();
}

// ── Chart updater ─────────────────────────────────────────────────────────────
function updateChart() {
  var n    = currentN;
  var diff = currentDiff;

  if (n !== null) {
    var mde05 = calcMDE(n, 0.05);
    var mde10 = calcMDE(n, 0.10);
    chart.data.datasets[2].data = [
      { x: n, y: 0 },
      { x: n, y: mde10 },
      { x: n, y: mde05 }
    ];
    chart.data.datasets[2].pointRadius = [0, 5, 5];
  } else {
    chart.data.datasets[2].data = [];
  }

  if (diff !== null) {
    chart.data.datasets[3].data = [
      { x: 500,     y: diff },
      { x: 1000000, y: diff }
    ];
    chart.data.datasets[3].pointRadius = [0, 0];
  } else {
    chart.data.datasets[3].data = [];
  }

  if (n !== null && diff !== null) {
    chart.data.datasets[4].data = [{ x: n, y: diff }];
  } else {
    chart.data.datasets[4].data = [];
  }

  chart.update('none');
  updateVerdict(n, diff);
}

function updateVerdict(n, diff) {
  var el   = document.getElementById('verdict');
  var icon = document.getElementById('verdict-icon');
  var text = document.getElementById('verdict-text');

  if (n === null || diff === null) {
    el.className = 'verdict';
    return;
  }

  var mde05     = calcMDE(n, 0.05);
  var mde10     = calcMDE(n, 0.10);
  var nNeeded05 = calcN(diff, 0.05);
  var nNeeded10 = calcN(diff, 0.10);

  if (diff >= mde05) {
    el.className = 'verdict show detectable';
    icon.textContent = '✓';
    text.innerHTML = '<strong>Detectable at both α = 0.05 and α = 0.10.</strong> Your observed difference of <strong>' + diff.toFixed(2) + '%</strong> exceeds the MDE of <strong>' + mde05.toFixed(2) + '%</strong> at ' + fmtNum(n) + ' impressions. Your test has enough power to confirm this result with confidence.';
  } else if (diff >= mde10) {
    el.className = 'verdict show partial';
    icon.textContent = '~';
    text.innerHTML = '<strong>Detectable at α = 0.10 only.</strong> Your difference of <strong>' + diff.toFixed(2) + '%</strong> clears the lenient threshold (' + mde10.toFixed(2) + '%) but not the strict one (' + mde05.toFixed(2) + '%). Consider this a tentative signal — you\'d need <strong>' + fmtNum(nNeeded05) + ' impressions</strong> to confirm it at α = 0.05.';
  } else {
    el.className = 'verdict show not-detectable';
    icon.textContent = '✕';
    text.innerHTML = '<strong>Not yet detectable.</strong> Your difference of <strong>' + diff.toFixed(2) + '%</strong> is below the MDE of <strong>' + mde10.toFixed(2) + '%</strong> at ' + fmtNum(n) + ' impressions. You\'d need at least <strong>' + fmtNum(nNeeded10) + ' impressions</strong> (α = 0.10) or <strong>' + fmtNum(nNeeded05) + '</strong> (α = 0.05) to reliably detect this effect.';
  }
}

// ── Impressions input ─────────────────────────────────────────────────────────
var impInput  = document.getElementById('imp-input');
var impError  = document.getElementById('imp-error');
var impMdeVal = document.getElementById('imp-mde-val');
var impMdeDet = document.getElementById('imp-mde-detail');

impInput.addEventListener('input', function() {
  var val = parseInt(impInput.value, 10);
  impError.textContent = '';
  impInput.classList.remove('error');

  if (!impInput.value) {
    currentN = null;
    impMdeVal.textContent = '—';
    impMdeDet.textContent = 'MDE (α 0.05)';
    updateChart(); return;
  }
  if (isNaN(val) || val < 100) {
    impError.textContent = 'Enter at least 100.';
    impInput.classList.add('error');
    currentN = null; updateChart(); return;
  }
  if (val > 10000000) {
    impError.textContent = 'Max 10M impressions.';
    impInput.classList.add('error');
    currentN = null; updateChart(); return;
  }

  currentN = val;
  var mde = calcMDE(val, 0.05);
  impMdeVal.textContent = mde.toFixed(2) + '%';
  impMdeDet.textContent = 'MDE at α 0.05';
  updateChart();
});

// ── CTR diff input ────────────────────────────────────────────────────────────
var ctrInput  = document.getElementById('ctr-input');
var ctrError  = document.getElementById('ctr-error');
var ctrImpVal = document.getElementById('ctr-imp-val');
var ctrImpDet = document.getElementById('ctr-imp-detail');

ctrInput.addEventListener('input', function() {
  var val = parseFloat(ctrInput.value);
  ctrError.textContent = '';
  ctrInput.classList.remove('error');

  if (!ctrInput.value) {
    currentDiff = null;
    ctrImpVal.textContent = '—';
    ctrImpDet.textContent = 'impressions needed';
    updateChart(); return;
  }
  if (isNaN(val) || val <= 0) {
    ctrError.textContent = 'Enter a positive difference.';
    ctrInput.classList.add('error');
    currentDiff = null; updateChart(); return;
  }
  if (val > 5) {
    ctrError.textContent = 'Max 5 percentage points.';
    ctrInput.classList.add('error');
    currentDiff = null; updateChart(); return;
  }

  currentDiff = val;
  var needed = calcN(val, 0.05);
  ctrImpVal.textContent = fmtNum(needed);
  ctrImpDet.textContent = 'needed (α 0.05)';
  updateChart();
});
</script>
</body>
</html>
